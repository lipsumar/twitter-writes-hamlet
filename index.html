<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Twitter writes Hamlet</title>
	<link href='https://fonts.googleapis.com/css?family=Crimson+Text' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="style.css">
	<meta name="viewport" content="width=device-width, user-scalable=no">
</head>
<body>
	<div class="app">
		<div class="app__page">
			<div class="text">
				<div class="text__stage-direction" style="margin-top:3em">LOADING...</div>
			</div>

		</div>
		<div class="app__aside">
			<div class="hero">
				<div class="hero__text hero__text--percent">4%</div>
				<div class="hero__text">Hamlet written so&nbsp;far</div>
			</div>
			<div class="about-text">
				Maecenas sed diam eget risus varius blandit sit amet non magna. Duis mollis, est non commodo luctus, nisi erat porttitor ligula, eget lacinia odio sem nec elit. Morbi leo risus, porta ac consectetur ac, vestibulum at eros. Nullam quis risus eget urna mollis ornare vel eu leo. Praesent commodo cursus magna, vel scelerisque nisl consectetur et.
			</div>
		</div>
	</div>
</body>
</html>
	<script src="node_modules/jquery/dist/jquery.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
var socket = io();

socket.on('state', function(resp){
	console.log(resp);
	var html = '';

	for (var i = 0; i < resp.htmlPieces.length; i++) {
		html+= resp.htmlPieces[i].html;
	}
	$('.text').html(html);
	$('.text').find('span').each(function(){
		var i = parseInt(this.getAttribute('data-i'), 10);
		if(i<resp.currentWordIndex){
			$(this).addClass('v');
		}
	});

	var $nextWord = getNextWord(resp.currentWordIndex-1);
	if($nextWord){
		$nextWord.addClass('looking');
	}

});
socket.on('word', function(resp){
	console.log('got index',resp.index);
	var $word = $('.text').find('span[data-i="'+resp.index+'"]');
	$word.removeClass('looking').addClass('v');
	var $nextWord = getNextWord(resp.index);
	if($nextWord){
		$nextWord.addClass('looking');
	}
});

function getNextWord(index){
	var $nextWord,i=1;
	while(true){
		$nextWord = $('.text').find('span[data-i="'+(index+i)+'"]');
		if($nextWord.length===1) break;
		i++;
		if(i>50) break;
	}
	return $nextWord;
}

/*
function addWord(tw){
	console.log(tw);
	if(tw.word==='\n'){
		$('#page').append('<br>');
		return;
	}
	var $word = $('<a class="word" href="https://twitter.com/'+tw.screen_name+'/status/'+tw.id+'" target="_blank">'+tw.word+'</a>');
	$('#page').append($word);
	$('#page').append(' ');

	var parts = cutTweet(tw);

	//var parts = tw.tweetText.split(tw.word);
	var t = parts.shift();
	t+= '<a class="tweet__word" href="https://twitter.com/'+tw.screen_name+'/status/'+tw.id+'" target="_blank">'+tw.clean+'</a>'+parts[0];
	var $tweet = $('<div class="tweet"><img class="tweet__avatar" src="'+tw.profile_image_url+'"><div class="tweet__handle">'+tw.screen_name+'</div><div class="tweet__text">'+t+'</div></div>');
	//$('#page').before($tweet);
	$word.append($tweet);
	$tweet.css({top:0,left:0});
	var tweetWordOffset = $tweet.find('.tweet__word').offset();
	var wordOffset = $word.offset();
	$tweet.css({
		top: wordOffset.top - tweetWordOffset.top,
		left:wordOffset.left - tweetWordOffset.left
	})

}

function cutTweet(tw){
	var parts = [];
	parts.push(tw.tweetText.substring(0,tw.charAt));
	//parts.push(tw.tweetText.substring(tw.charAt, tw.charAt+tw.word.length))
	parts.push(tw.tweetText.substring(tw.charAt+tw.clean.length));
	return parts;
}*/
	</script>
</body>
</html>